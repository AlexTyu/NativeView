<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<script src="js/three.min.js"></script>
	<script src="js/STLLoader.js"></script>
	<script src="js/DAT.GUI.min.js"></script>
	<script src="js/stats.js"></script>
	<link href="styles.css" rel="stylesheet">

	<script>
		window._alert = window.alert;
		window.alert = function () {
		};
	</script>

		<script src="js/bezier-spline.js"></script>

		<script>
		function loadModule()
			{
				 var head= document.getElementsByTagName('head')[0];
				 var script= document.createElement('script');
				 script.type= 'text/javascript';
				 script.setAttribute("id", "loadmodule");
				 script.src= '/js/loadModule.js';
				 head.appendChild(script);
			}

			function load_js()
				{
					 var head= document.getElementsByTagName('head')[0];
					 var script= document.createElement('script');
					 script.type= 'text/javascript';
					 script.setAttribute("id", "facetracker");
					 script.src= '/js/facetracker.js';
					 head.appendChild(script);
				}

					loadModule();
					load_js();


			function timedRefresh(timeoutPeriod) {
				setTimeout("location.reload();",timeoutPeriod);
			}


			</script>
			<script id='loadmodule'></script>
			<script id='facetracker'></script>


</head>
<body>

	<div id="toolbar">
		<div class="logo"></div>
	</div>

	<tracker>
		<div id="container" style="overflow: hidden;margin-left: 100px;">
			<canvas id="canvas" width="640" height="480" style="float:left;border:1px solid black;-webkit-transform: scaleX(-1);-moz-transform: scaleX(-1);"></canvas>
			<div id="resume" style="display: none; margin-left:50px;float:left;"><a onclick="toggleSlider();"><i><b>Results (Click here):</b></i></a>
			<div id="panelThatSlides" style="position: relative; left: 0px; background-color: rgb(238, 238, 238); width: 300px; display: none; background-position: initial initial; background-repeat: initial initial;">
				<div id="contentThatFades" style="display: none; position: relative; left: 0px; background-color: rgb(238, 238, 238); width: 300px; display: block; background-position: initial initial; background-repeat: initial initial;">
					<div id="data">
					<p>FPS CALCULATED: <b id="boldStuff">29.3fps</b> </p>
					<p>FPS FROM TRACKER: <b id="fpsTracker">----</b> </p>
					<p>TRANSLATION: <b id="myTrans">----</b> </p>
					<p>ROTATION: <b id="myRot">----</b> </p>
					<p>STATUS: <b id="myStat">[TRACK_STAT_OFF]</b> </p>
					</div>
				</div>
			</div>
		</div>
		</div>
		<div id="toolbox" style = " display: none; margin-left: 100px; margin-right:auto; margin-top:10px">
			<select id="myList" onchange="testConfig()">
			  <option>Facial Features Tracker - High.cfg</option>
			  <option>Facial Features Tracker - Low.cfg</option>
			  <option>Head Tracker.cfg</option>
			</select>
		</div>
	</tracker>

	<script id="sdk" src="../../lib/visageSDK.js"></script>

	<script id="tracker">
	</script>

	<script>


	var container, neck, camera, scene, renderer

	container=document.createElement('div');
	document.body.appendChild(container);

	function degInRad(deg) {
	    return deg * Math.PI / 180;
	}

	scene=new THREE.Scene();

	camera = new THREE.PerspectiveCamera(20, window.innerWidth / window.innerHeight, 1, 10000);

	neck = new THREE.Object3D();
	neck.up = new THREE.Vector3(0, 0, 1);
	neck.position.z = 1;
	neck.position.y = 0;

	neck.add(camera);
	scene.add(neck);

	// object
	var loader = new THREE.STLLoader();

	loader.addEventListener('load', function (event){
	    var geometry=event.content;
	    var material=new THREE.MeshNormalMaterial({
	        linewidth: 0.01,
	        wireframe: true,
	        ambient: 0xFBB917,
	        transparent: true,
	        opacity: 0.3,
	    });

	    var mesh=new THREE.Mesh(geometry, material);
	        mesh.name="model"
	        mesh.scale.set(0.2, 0.2, 0.2);
	        mesh.translateY(0)
	        mesh.translateX(0)
	        mesh.translateZ(0)

	    mesh.material.needsUpdate = true;

			//MODEL HERE
	    // scene.add(mesh);

	    }

	);

	// STL file to be loaded
	loader.load('test.stl');
	var object = scene.getObjectByName("model");

	// renderer
	renderer=new THREE.WebGLRenderer({ antialias: true });
	renderer.setSize(window.innerWidth, window.innerHeight);

	//appliyng to canvas
	container.appendChild(renderer.domElement);

	window.addEventListener('resize', onWindowResize, false);

	var boxWidth = 90;
	var skyloader = new THREE.TextureLoader();
	skyloader.load('img/box.png', onTextureLoaded);

	animate();

	function onTextureLoaded(texture) {
	  texture.wrapS = THREE.RepeatWrapping;
	  texture.wrapT = THREE.RepeatWrapping;
	  texture.repeat.set(boxWidth, boxWidth);

	  var geometry = new THREE.BoxGeometry(boxWidth, boxWidth, boxWidth);
	  var material = new THREE.MeshBasicMaterial({
	    map: texture,
	    transparent: true,
	    opacity: 0.2,
	    color: 0x01BE00,
	    side: THREE.BackSide
	  });

	  var skybox = new THREE.Mesh(geometry, material);
	  scene.add(skybox);
	  skybox.scale.set(100, 100, 100);
	}

	neck = new THREE.Object3D();

	camera.position.y = 10;
	camera.position.z = 150;
	camera.flighAround = true;


	function onWindowResize(){
	    camera.aspect=window.innerWidth / window.innerHeight;
	    camera.updateProjectionMatrix();
	    renderer.setSize(window.innerWidth, window.innerHeight);
	}


	function render(){
			var timer=Date.now() * 0.000001;
			r=150;
			var faceData = faceData;
			var object = scene.getObjectByName("model");
			// var headPosition = faceData.getFaceTranslation();
			// var headRoration = faceData.getFaceRotation();
	    if (camera.flighAround){
	        // object.rotation.y=r*Math.sin(timer);
	        // camera.position.x=r*Math.cos(timer);
	        // camera.position.z=r*Math.sin(timer);
	    }
	    camera.lookAt(scene.position);
	    renderer.render(scene, camera);
	    renderer.setClearColor(0x000000, 1);

		// camera.position.x=100 - headPosition[2]*300;
		// object.rotation.x =  -headRotation[0];
		//
		// camera.position.y = - headRotation[1];
		// object.position.y =  - headPosition[1]*100;
		//
		// camera.position.z=20 + headPosition[2]*100;
		// object.position.z=  - headPosition[3]*300;

	}


	function animate(){
		requestAnimationFrame(animate);
		render();
	}





	// function streamData(Data){
	// 	var text = document.getElementById('gaze');
	// 	var pointer = document.getElementById('pointer');
	// 	var faceData = Data;
	// 	var gaze = faceData.getGazeDirection();
	// 	var gazeX = window.innerWidth / 2;
	// 	var gazeY = window.innerHeight / 2;
	// 	var transformY = gaze[0] * gazeY;
	// 	var transformX = gaze[1] * gazeX;
	// 	text.innerHTML = gazeX + "gaze:" + gaze;
	// 	pointer.style.transform = 'translate3d('+ -transformX + 'px,' + -transformY + 'px,0)'
	// }

	function streamData(Data){
		var text = document.getElementById('gaze');
		var pointer = document.getElementById('pointer');
		var faceData = Data;
		var screenGazeData = faceData.gazeData;
		var gaze = faceData.getGazeDirectionGlobal();
		var gazeX = window.innerWidth / 2;
		var gazeY = window.innerHeight / 2;
		var transformY = (gaze[0]*3) * gazeY;
		var transformX = (gaze[1]*2) * gazeX;
		text.innerHTML = gaze[0] + '<br>' + gaze[1] + '<br>' + gaze[2];
		pointer.style.transform = 'translate3d('+ -transformX + 'px,' + transformY + 'px,0)'
	}

	var settings = function() {
		this.autoreload = true;
	};

	var settings = new settings();

	pageautoRefresh();
	function pageautoRefresh(){
		if (settings.autoreload){
				window.onload = timedRefresh(60000);
				console.log('da')
		} else {
				window.onload = timedRefresh(6000000);
				console.log('ne')
		}
	}


	var reloader = { add:function(){ console.log("clicked") }};

	var gui = new dat.GUI({autoPlace: false});
	var guiContainer = document.getElementById('toolbar');
	guiContainer.appendChild(gui.domElement);


	var firstTab = gui.addFolder("Settings");
	firstTab.add(reloader,'add');

	var autoreloadController = firstTab.add(settings, 'autoreload');
	autoreloadController.onChange(function(value) {
		pageautoRefresh()
	});

	firstTab.open();

	// var headRotation = faceData.getFaceRotation();
	// console.log(headRotation)

	var cameraFolder = gui.addFolder("Camera");
	    cameraFolder.add(camera.position, "x", 0, 150);
	    cameraFolder.add(camera.position, "y", 0, 150);
	    cameraFolder.add(camera.position, "z", 0, 150);

			cameraFolder.add(camera.rotation, "x", 0, 6.27);
			cameraFolder.add(camera.rotation, "y", 0, 6.27);
			cameraFolder.add(camera.rotation, "z", 0, 6.27);

	var appearanceFolder = gui.addFolder("Headtracking");
	var objectBehaviour = gui.addFolder("Object Behavior");

	var EnvironmentFolder = gui.addFolder("Environment");
	var SimulationsFolder = gui.addFolder("Simulations");
	var metricsFolder = gui.addFolder("Metrics");


	gui.add(camera, "flighAround");

	window._alert = window.alert;
	window.alert = function () {
	};

	</script>

	<div id="gaze" style="position: absolute; top: 0; left: 0; color: white">lol</div>
	<div id="pointer" style="position: absolute; top: 0; right: 0; bottom: 0; left: 0; margin: auto; width: 30px; height: 30px; border-radius: 100px; background: red; z-index: 100;"></div>

</body>
</html>
